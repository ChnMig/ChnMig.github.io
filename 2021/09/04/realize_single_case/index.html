<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>å•ä¾‹çš„å®ç° - ChnMigçš„ä¸ªäººç½‘ç«™</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ChnMigçš„ä¸ªäººç½‘ç«™"><meta name="msapplication-TileImage" content="/images/logo.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ChnMigçš„ä¸ªäººç½‘ç«™"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°"><meta property="og:type" content="blog"><meta property="og:title" content="å•ä¾‹çš„å®ç°"><meta property="og:url" content="https://chnmig.github.io/2021/09/04/realize_single_case/"><meta property="og:site_name" content="ChnMigçš„ä¸ªäººç½‘ç«™"><meta property="og:description" content="å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8"><meta property="article:published_time" content="2021-09-03T16:00:00.000Z"><meta property="article:modified_time" content="2021-09-03T16:00:00.000Z"><meta property="article:author" content="ChnMig"><meta property="article:tag" content="Python"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chnmig.github.io/2021/09/04/realize_single_case/"},"headline":"å•ä¾‹çš„å®ç°","image":[],"datePublished":"2021-09-03T16:00:00.000Z","dateModified":"2021-09-03T16:00:00.000Z","author":{"@type":"Person","name":"ChnMig"},"publisher":{"@type":"Organization","name":"ChnMigçš„ä¸ªäººç½‘ç«™","logo":{"@type":"ImageObject","url":"https://chnmig.github.io/images/logo.gif"}},"description":"å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°"}</script><link rel="canonical" href="https://chnmig.github.io/2021/09/04/realize_single_case/"><link rel="icon" href="/images/logo.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?5306a4ae74c103fc71e3fb36eb8f9609";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.gif" alt="ChnMigçš„ä¸ªäººç½‘ç«™" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">ä¸»é¡µ</a><a class="navbar-item" href="/archives">å½’æ¡£</a><a class="navbar-item" href="/categories">ç±»åˆ«</a><a class="navbar-item" href="/tags">æ ‡ç­¾</a><a class="navbar-item" href="/about">å…³äº</a><a class="navbar-item" target="_blank" rel="noopener" href="http://tongji.baidu.com/web/welcome/ico?s=5306a4ae74c103fc71e3fb36eb8f9609">è®¿é—®ç»Ÿè®¡</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-03T16:00:00.000Z" title="2021/9/4 ä¸Šåˆ12:00:00">2021-09-04</time>å‘è¡¨</span><span class="level-item"><time dateTime="2021-09-03T16:00:00.000Z" title="2021/9/4 ä¸Šåˆ12:00:00">2021-09-04</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/">ç¼–ç¨‹</a></span><span class="level-item">18 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦2671ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile">å•ä¾‹çš„å®ç°</h1><div class="content"><h2 id="å•ä¾‹çš„å®ç°">å•ä¾‹çš„å®ç°</h2>
<p>æå‰ç¥å¤§å®¶è¿‡ä¸ªå¥½å¹´</p>
<p>æœ€è¿‘å¿™äºé¡¹ç›®,ä»Šå¤©æŠ½å‡ºç‚¹æ—¶é—´å†™å†™Blog</p>
<p>æœ¬ç¯‡å°±å†™Pythonçš„å•ä¾‹å®ç°å§, å°±æ‹¿è‡ªå¸¦çš„æ¨¡å—<code>logging</code>ä¸¾ä¾‹å§</p>
<p>Pythonçš„<code>logging</code>æ¨¡å—æ˜¯Pythonè‡ªå¸¦çš„æ¨¡å—,å¯æ–¹ä¾¿å¿«æ·çš„è¿›è¡Œæ—¥å¿—çš„è®°å½•</p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/logging.html">python doc</a></p>
<h2 id="loggingæœ¬èº«å°±æ˜¯å•ä¾‹çš„">loggingæœ¬èº«å°±æ˜¯å•ä¾‹çš„</h2>
<p>è¯¥æ¨¡å—æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„,ä¸‹é¢çš„æ³¨é‡Šæ‘˜æŠ„è‡³ doc</p>
<blockquote>
<p>The logging module is intended to be thread-safe without any special work needing to be done by its clients. It achieves this though using threading locks; there is one lock to serialize access to the moduleâ€™s shared data, and each handler also creates a lock to serialize access to its underlying I/O.</p>
<p>If you are implementing asynchronous signal handlers using the signal module, you may not be able to use logging from within such handlers. This is because lock implementations in the threading module are not always re-entrant, and so cannot be invoked from such signal handlers.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ä½ ä¸éœ€è¦å…³æ³¨å¤šçº¿ç¨‹çš„é—®é¢˜,åªè¦ <code>getLogger()</code> æ—¶æŒ‡å®šå½“å‰ç©ºé—´å³å¯</p>
<blockquote>
<p>Loggers have the following attributes and methods. Note that Loggers should NEVER be instantiated directly, but always through the module-level function logging.getLogger(name). Multiple calls to getLogger() with the same name will always return a reference to the same Logger object.</p>
<p>The name is potentially a period-separated hierarchical value, like foo.bar.baz (though it could also be just plain foo, for example). Loggers that are further down in the hierarchical list are children of loggers higher up in the list. For example, given a logger with a name of foo, loggers with names of foo.bar, foo.bar.baz, and foo.bam are all descendants of foo. The logger name hierarchy is analogous to the Python package hierarchy, and identical to it if you organise your loggers on a per-module basis using the recommended construction logging.getLogger(<strong>name</strong>). Thatâ€™s because in a module, <strong>name</strong> is the moduleâ€™s name in the Python package namespace.</p>
</blockquote>
<p>æ„æ€æ˜¯ <code>logger.getLogger()</code> æ—¶ä¼ å…¥ç›¸åŒçš„å˜é‡,ä¼šæ°¸è¿œè¿”å›åŒä¸€ä¸ªå¯¹è±¡,æ¯”å¦‚æˆ‘åœ¨å½“å‰è¿›ç¨‹å†…çš„ä»»ä½•åœ°æ–¹, ä½¿ç”¨ <code>log = logger.getLogger("work")</code> ç”Ÿæˆçš„logå¯¹è±¡ä¸€ç›´æ˜¯åŒä¸€ä¸ªå¯¹è±¡,è¿™å°±æ˜¯å•ä¾‹æ¨¡å¼,å®˜æ–¹æ¨èä¼ å…¥ <code>__name__</code> å› ä¸ºä»–æ˜¯PythonåŒ…å‘½åç©ºé—´ä¸­æ¨¡å—çš„åç§°ã€‚</p>
<p>ä½¿ç”¨loggingæ¥è®²å•ä¾‹çº¯ç²¹æ˜¯ä¸€æ—¶é—´æ²¡æƒ³åˆ°æœ‰å•¥èƒ½ä¸¾ä¾‹å­çš„, æˆ‘ä»¬å°±å…ˆå‡å¦‚ä»–ä¸æ˜¯å•ä¾‹çš„å§<span class="github-emoji" style="display:inline;vertical-align:middle"><span>ğŸ˜¬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h2 id="ä¸å†™å•ä¾‹çš„æ™®é€šç±»">ä¸å†™å•ä¾‹çš„æ™®é€šç±»</h2>
<blockquote>
<p>æ‰‹åŠ¨å†™ä¸€ä¸ªå•ä¾‹å®Œå…¨æ˜¯ä¸ºäº†è®°å¿†å•ä¾‹æ¨¡å¼çš„ä½¿ç”¨,åªæ˜¯ä»¥ logging æ¨¡å—ä¸¾ä¾‹</p>
</blockquote>
<p>å…ˆå†™ä¸€ä¸ªæ™®é€šçš„ç±», è¿™ä¸ªç±»å°è£…äº†<code>logging</code>ç±», æ²¡æœ‰è€ƒè™‘å•ä¾‹é—®é¢˜</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log æ—¥å¿—</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># æ—¥å¿—ç­‰çº§</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s % (levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># æ ¼å¼åŒ–ç»“æ„</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># æ˜¯å¦è¾“å‡º</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># ä¿å­˜çš„æ–‡ä»¶å</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># æ—¥å¿—æ–‡ä»¶æŒ‰æ—¶é—´åˆ‡åˆ†</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># ä¿ç•™æ—¥å¿—æ–‡ä»¶æœ€å¤§æ•°é‡</span></span><br><span class="line">        <span class="comment"># æ—¥å¿—çº§åˆ«åŒ¹é…</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># è¾“å‡º</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># ä¿å­˜</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæˆ‘ä»¬åŒæ—¶èµ·å¤šä¸ªçº¿ç¨‹å»ä½¿ç”¨, å¯èƒ½å°±ä¼šå‡ºç°æ„æ–™ä¹‹å¤–çš„é—®é¢˜</p>
<h2 id="åˆ©ç”¨-new-å®ç°å•ä¾‹">åˆ©ç”¨ <code>__new__</code> å®ç°å•ä¾‹</h2>
<p>æˆ‘ä»¬çŸ¥é“,pythonå®ä¾‹åŒ–æ—¶å…¶å®æ˜¯å…ˆèµ° <code>__new__</code> å†èµ° <code>__init__</code></p>
<p>æˆ‘ä»¬å¯ä»¥é‡å†™ <code>__new__</code> æ–¹æ³•,å¦‚æœå‘ç°å·²ç”Ÿæˆå¯¹è±¡ç›´æ¥è¿”å›è¯¥å¯¹è±¡</p>
<p>åŒæ—¶ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹çš„èµ„æºç«äº‰,æˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹é”æ¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—® <code>__new__</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log æ—¥å¿—</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨çº¿ç¨‹é”é˜²æ­¢åŒä¸€æ—¶é—´å¤šä¸ªçº¿ç¨‹è°ƒç”¨__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># æ—¥å¿—ç­‰çº§</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># æ ¼å¼åŒ–ç»“æ„</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># æ˜¯å¦è¾“å‡º</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># ä¿å­˜çš„æ–‡ä»¶å</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># æ—¥å¿—æ–‡ä»¶æŒ‰æ—¶é—´åˆ‡åˆ†</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># ä¿ç•™æ—¥å¿—æ–‡ä»¶æœ€å¤§æ•°é‡</span></span><br><span class="line">        <span class="comment"># æ—¥å¿—çº§åˆ«åŒ¹é…</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># è¾“å‡º</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># ä¿å­˜</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®ä¾‹åŒ–æ—¶å…ˆèµ°è¿™é‡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># å•ä¾‹æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># æ£€æŸ¥è¿™ä¸ªç±»æœ‰æ²¡æœ‰_instanceå±æ€§</span></span><br><span class="line">            <span class="keyword">with</span> MyLogger._instance_lock:  <span class="comment"># è·å–é”</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># è¿™é‡Œè·å–åˆ°é”, ä½†æ˜¯æœ‰å¯èƒ½åœ¨è·å–ä¸­æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ›å»ºäº†å¯¹è±¡, æ‰€ä»¥è¿™é‡Œå†åˆ¤æ–­ä¸€æ¬¡</span></span><br><span class="line">                    <span class="comment"># æ²¡æœ‰å®ä¾‹åŒ–è¿‡</span></span><br><span class="line">                    MyLogger._instance = <span class="built_in">object</span>.__new__(cls)  <span class="comment"># è°ƒç”¨objectçš„__new__æ–¹æ³•, ç„¶åè‡ªåŠ¨è°ƒç”¨æœ¬ç±»çš„__init__è¿›è¡Œå®ä¾‹åŒ–, å°†å®ä¾‹åŒ–çš„å¯¹è±¡èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">return</span> MyLogger._instance  <span class="comment"># å¦‚æœå·²ç»æœ‰äº†è¿™ä¸ªå±æ€§ç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>è¿è¡Œæµ‹è¯•ä»£ç , å‘ç°è¿˜æ˜¯ä¼šæœ‰é—®é¢˜</p>
<p>è°ƒè¯•åå‘ç°, å³ä½¿ä»£ç æ­£ç¡®æ•æ‰åˆ°äº† <code>_instance</code> å·²ç»å­˜åœ¨, å°†å…¶è¿”å›äº†, ä½†æ˜¯å› ä¸º <code>_instance</code> æ˜¯ <code>__new__</code> çš„, è¿˜æ²¡æœ‰è¿›è¡Œ <code>__init__</code> è°ƒç”¨, æ‰€ä»¥æ¯æ¬¡åˆé‡æ–°è¿è¡Œ <code>__init__</code> , å› ä¸º <code>__init__</code> é‡Œæœ‰ç»™ <code>logging</code> æ·»åŠ  <code>handler</code> çš„æ“ä½œ, æ‰€ä»¥éšç€çº¿ç¨‹çš„å¢å¤š, æ¯æ¬¡éƒ½ä¼šå¤šæ·»åŠ ä¸€ä¸ª <code>handler</code>, å¯¼è‡´è®°å½•ä¸€æ¬¡ <code>logging</code> è®°å½•äº†å¤šä¸ª <code>handler</code>, æ¯æ¬¡è®°å½•æ—¥å¿—å°±ä¼šé‡å¤è®°å½•å¾ˆå¤šæ¬¡</p>
<h2 id="åˆ©ç”¨-call-å®ç°">åˆ©ç”¨<code>__call__</code>å®ç°</h2>
<p>æˆ‘ä»¬å°†ä»£ç æ”¹é€ æˆ</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line">    <span class="comment"># è¯¥ç±»ç»§æ‰¿å…ƒç±»</span></span><br><span class="line">    _instance_lock = threading.Lock()  <span class="comment"># çº¿ç¨‹é”</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">         <span class="comment"># å•ä¾‹æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls, <span class="string">"_instance"</span>):  <span class="comment"># æ£€æŸ¥è¿™ä¸ªç±»æœ‰æ²¡æœ‰_instanceå±æ€§</span></span><br><span class="line">            <span class="keyword">with</span> cls._instance_lock:  <span class="comment"># è·å–é”</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls, <span class="string">"_instance"</span>):  <span class="comment"># è¿™é‡Œè·å–åˆ°é”, ä½†æ˜¯æœ‰å¯èƒ½åœ¨è·å–ä¸­æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ›å»ºäº†å¯¹è±¡, æ‰€ä»¥è¿™é‡Œå†åˆ¤æ–­ä¸€æ¬¡</span></span><br><span class="line">                    <span class="comment"># æ²¡æœ‰å®ä¾‹åŒ–è¿‡</span></span><br><span class="line">                    cls._instance = <span class="built_in">super</span>(SingletonType, cls).__call__(*args, **kwargs)  <span class="comment"># æ²¡æœ‰å®ä¾‹åŒ–è¿‡, è°ƒç”¨typeåŸºç±»çš„__call__æ–¹æ³•, èµ°æ­£å¸¸çš„æµç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>(<span class="params">metaclass=SingletonType</span>):</span></span><br><span class="line">    <span class="comment"># log æ—¥å¿—</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨çº¿ç¨‹é”é˜²æ­¢åŒä¸€æ—¶é—´å¤šä¸ªçº¿ç¨‹è°ƒç”¨__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># æ—¥å¿—ç­‰çº§</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># æ ¼å¼åŒ–ç»“æ„</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># æ˜¯å¦è¾“å‡º</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># ä¿å­˜çš„æ–‡ä»¶å</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># æ—¥å¿—æ–‡ä»¶æŒ‰æ—¶é—´åˆ‡åˆ†</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># ä¿ç•™æ—¥å¿—æ–‡ä»¶æœ€å¤§æ•°é‡</span></span><br><span class="line">        <span class="comment"># æ—¥å¿—çº§åˆ«åŒ¹é…</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># è¾“å‡º</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># ä¿å­˜</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨è¿™ä¸ªä»£ç ä¸­, æˆ‘ä»¬æŒ‡å®šäº†<code>MyLogger</code> çš„å…ƒç±»æ˜¯ <code>SingletonType</code>,  å…¶å®åœ¨pythonä¸­å®ä¾‹åŒ–å¯¹è±¡éƒ½æ˜¯åœ¨å£°æ˜è¿™ä¸ªç±»æ—¶æ‰§è¡Œ<code>type</code>çš„<code>__new__</code>å’Œ<code>__init__</code>(è¿™é‡Œæ¯æ¬¡å£°æ˜ä¸€ä¸ªæ–°çš„ç±»éƒ½ä¼šèµ°ä¸€é), ç„¶ååœ¨åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œ<code>type</code>çš„<code>__call__</code>, åœ¨<code>__call__</code>ä¸­è°ƒç”¨è‡ªå®šä¹‰ç±»çš„<code>__new__</code>å’Œ<code>__init__</code></p>
<p>æˆ‘ä»¬ä¸»è¦æ˜¯ä¿®æ”¹äº†<code>SingletonType</code> çš„<code>__call__</code>, å½“å®ä¾‹åŒ–æ—¶é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨äº†, ä¸å­˜åœ¨å†èµ°<code>super</code> ä¹Ÿå°±æ˜¯ <code>type</code> çš„<code>__call__</code>æµç¨‹</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98440398">ä¸€æ–‡ææ‡‚ä»€ä¹ˆæ˜¯Pythonçš„metaclass - çŸ¥ä¹ (zhihu.com)</a></p>
<p>å½“ç„¶å¯¹äºè‡ªå®šä¹‰<code>metaclass</code>, å¼€å‘è€…ä»¬æœ‰ç›¸å½“ä¸€éƒ¨åˆ†æ˜¯è®¤ä¸ºå…¶ä¼šç ´åä»£ç çš„å¯è¯»æ€§ç­‰, å¦‚æœä½ ä¹Ÿè¿™ä¹ˆè§‰å¾—, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹ä¸€ä¸ªæ–¹æ³•</p>
<h2 id="è‡ªå†™åˆå§‹åŒ–æ–¹æ³•">è‡ªå†™åˆå§‹åŒ–æ–¹æ³•</h2>
<p>æˆ‘ä»¬å›çœ‹ç¬¬ä¸€ç§æ–¹æ³•, ä¹‹æ‰€ä»¥æœ‰é—®é¢˜æ˜¯æ¯æ¬¡åœ¨<code>__init__</code>æ—¶ä¼šæ·»åŠ ä¸€ä¸ª<code>handler</code>, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¿®æ”¹é€»è¾‘, è®©ä»–é€šè¿‡åˆ«çš„æ–¹æ³•æ¥æ·»åŠ <code>handler</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log æ—¥å¿—</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨çº¿ç¨‹é”é˜²æ­¢åŒä¸€æ—¶é—´å¤šä¸ªçº¿ç¨‹è°ƒç”¨__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_instance_init</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># æ—¥å¿—ç­‰çº§</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># æ ¼å¼åŒ–ç»“æ„</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># æ˜¯å¦è¾“å‡º</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># ä¿å­˜çš„æ–‡ä»¶å</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># æ—¥å¿—æ–‡ä»¶æŒ‰æ—¶é—´åˆ‡åˆ†</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># ä¿ç•™æ—¥å¿—æ–‡ä»¶æœ€å¤§æ•°é‡</span></span><br><span class="line">        <span class="comment"># æ—¥å¿—çº§åˆ«åŒ¹é…</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># è¾“å‡º</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># ä¿å­˜</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®ä¾‹åŒ–æ—¶å…ˆèµ°è¿™é‡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># å•ä¾‹æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># æ£€æŸ¥è¿™ä¸ªç±»æœ‰æ²¡æœ‰_instanceå±æ€§</span></span><br><span class="line">            <span class="keyword">with</span> MyLogger._instance_lock:  <span class="comment"># è·å–é”</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># è¿™é‡Œè·å–åˆ°é”, ä½†æ˜¯æœ‰å¯èƒ½åœ¨è·å–ä¸­æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ›å»ºäº†å¯¹è±¡, æ‰€ä»¥è¿™é‡Œå†åˆ¤æ–­ä¸€æ¬¡</span></span><br><span class="line">                    <span class="comment"># æ²¡æœ‰å®ä¾‹åŒ–è¿‡</span></span><br><span class="line">                    MyLogger._instance = <span class="built_in">object</span>.__new__(cls)  <span class="comment"># è°ƒç”¨objectçš„__new__æ–¹æ³•, ç„¶åè‡ªåŠ¨è°ƒç”¨æœ¬ç±»çš„__init__è¿›è¡Œå®ä¾‹åŒ–, å°†å®ä¾‹åŒ–çš„å¯¹è±¡èµ‹å€¼</span></span><br><span class="line">                    MyLogger._instance._instance_init(*args, **kwargs)  <span class="comment"># åªæœ‰ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶æ‰æ‰§è¡Œhandler</span></span><br><span class="line">        <span class="keyword">return</span> MyLogger._instance  <span class="comment"># å¦‚æœå·²ç»æœ‰äº†è¿™ä¸ªå±æ€§ç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>ä¿è¯æ¯æ¬¡åªåœ¨éœ€è¦çš„æ—¶å€™æ·»åŠ <code>handler</code> å³å¯</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>å•ä¾‹çš„å®ç°</p><p><a href="https://chnmig.github.io/2021/09/04/realize_single_case/">https://chnmig.github.io/2021/09/04/realize_single_case/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><p>ChnMig</p></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2021-09-04</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2021-09-04</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/04/leet_code(1-10)/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">LeetCodeè§£é¢˜(1-10)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/09/04/rust_programming_language(1)/"><span class="level-item">Rustç¨‹åºè®¾è®¡è¯­è¨€(1)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">è¯„è®º</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://chnmig.github.io/2021/09/04/realize_single_case/';
            this.page.identifier = '2021/09/04/realize_single_case/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'chnmig' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#å•ä¾‹çš„å®ç°"><span class="level-left"><span class="level-item">1</span><span class="level-item">å•ä¾‹çš„å®ç°</span></span></a></li><li><a class="level is-mobile" href="#loggingæœ¬èº«å°±æ˜¯å•ä¾‹çš„"><span class="level-left"><span class="level-item">2</span><span class="level-item">loggingæœ¬èº«å°±æ˜¯å•ä¾‹çš„</span></span></a></li><li><a class="level is-mobile" href="#ä¸å†™å•ä¾‹çš„æ™®é€šç±»"><span class="level-left"><span class="level-item">3</span><span class="level-item">ä¸å†™å•ä¾‹çš„æ™®é€šç±»</span></span></a></li><li><a class="level is-mobile" href="#åˆ©ç”¨-new-å®ç°å•ä¾‹"><span class="level-left"><span class="level-item">4</span><span class="level-item">åˆ©ç”¨ __new__ å®ç°å•ä¾‹</span></span></a></li><li><a class="level is-mobile" href="#åˆ©ç”¨-call-å®ç°"><span class="level-left"><span class="level-item">5</span><span class="level-item">åˆ©ç”¨__call__å®ç°</span></span></a></li><li><a class="level is-mobile" href="#è‡ªå†™åˆå§‹åŒ–æ–¹æ³•"><span class="level-left"><span class="level-item">6</span><span class="level-item">è‡ªå†™åˆå§‹åŒ–æ–¹æ³•</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo.gif" alt="ChnMigçš„ä¸ªäººç½‘ç«™" height="28"></a><p class="is-size-7"><span>&copy; 2021 ChnMig</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ChnMig"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "æ­¤ç½‘ç«™ä½¿ç”¨Cookieæ¥æ”¹å–„æ‚¨çš„ä½“éªŒã€‚",
          dismiss: "çŸ¥é“äº†ï¼",
          allow: "å…è®¸ä½¿ç”¨Cookie",
          deny: "æ‹’ç»",
          link: "äº†è§£æ›´å¤š",
          policy: "Cookieæ”¿ç­–",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">Ã—</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>
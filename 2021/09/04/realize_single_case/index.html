<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>单例的实现 - ChnMig的个人网站</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ChnMig的个人网站"><meta name="msapplication-TileImage" content="/images/logo.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ChnMig的个人网站"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="单例模式的几种实现"><meta property="og:type" content="blog"><meta property="og:title" content="单例的实现"><meta property="og:url" content="https://chnmig.github.io/2021/09/04/realize_single_case/"><meta property="og:site_name" content="ChnMig的个人网站"><meta property="og:description" content="单例模式的几种实现"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8"><meta property="article:published_time" content="2021-09-03T16:00:00.000Z"><meta property="article:modified_time" content="2021-09-03T16:00:00.000Z"><meta property="article:author" content="ChnMig"><meta property="article:tag" content="Python"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chnmig.github.io/2021/09/04/realize_single_case/"},"headline":"单例的实现","image":[],"datePublished":"2021-09-03T16:00:00.000Z","dateModified":"2021-09-03T16:00:00.000Z","author":{"@type":"Person","name":"ChnMig"},"publisher":{"@type":"Organization","name":"ChnMig的个人网站","logo":{"@type":"ImageObject","url":"https://chnmig.github.io/images/logo.gif"}},"description":"单例模式的几种实现"}</script><link rel="canonical" href="https://chnmig.github.io/2021/09/04/realize_single_case/"><link rel="icon" href="/images/logo.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?5306a4ae74c103fc71e3fb36eb8f9609";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.gif" alt="ChnMig的个人网站" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">类别</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" target="_blank" rel="noopener" href="http://tongji.baidu.com/web/welcome/ico?s=5306a4ae74c103fc71e3fb36eb8f9609">访问统计</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-03T16:00:00.000Z" title="2021/9/4 上午12:00:00">2021-09-04</time>发表</span><span class="level-item"><time dateTime="2021-09-03T16:00:00.000Z" title="2021/9/4 上午12:00:00">2021-09-04</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span><span class="level-item">18 分钟读完 (大约2671个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">单例的实现</h1><div class="content"><h2 id="单例的实现">单例的实现</h2>
<p>提前祝大家过个好年</p>
<p>最近忙于项目,今天抽出点时间写写Blog</p>
<p>本篇就写Python的单例实现吧, 就拿自带的模块<code>logging</code>举例吧</p>
<p>Python的<code>logging</code>模块是Python自带的模块,可方便快捷的进行日志的记录</p>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/logging.html">python doc</a></p>
<h2 id="logging本身就是单例的">logging本身就是单例的</h2>
<p>该模块本身就是线程安全的,下面的注释摘抄至 doc</p>
<blockquote>
<p>The logging module is intended to be thread-safe without any special work needing to be done by its clients. It achieves this though using threading locks; there is one lock to serialize access to the module’s shared data, and each handler also creates a lock to serialize access to its underlying I/O.</p>
<p>If you are implementing asynchronous signal handlers using the signal module, you may not be able to use logging from within such handlers. This is because lock implementations in the threading module are not always re-entrant, and so cannot be invoked from such signal handlers.</p>
</blockquote>
<p>也就是说你不需要关注多线程的问题,只要 <code>getLogger()</code> 时指定当前空间即可</p>
<blockquote>
<p>Loggers have the following attributes and methods. Note that Loggers should NEVER be instantiated directly, but always through the module-level function logging.getLogger(name). Multiple calls to getLogger() with the same name will always return a reference to the same Logger object.</p>
<p>The name is potentially a period-separated hierarchical value, like foo.bar.baz (though it could also be just plain foo, for example). Loggers that are further down in the hierarchical list are children of loggers higher up in the list. For example, given a logger with a name of foo, loggers with names of foo.bar, foo.bar.baz, and foo.bam are all descendants of foo. The logger name hierarchy is analogous to the Python package hierarchy, and identical to it if you organise your loggers on a per-module basis using the recommended construction logging.getLogger(<strong>name</strong>). That’s because in a module, <strong>name</strong> is the module’s name in the Python package namespace.</p>
</blockquote>
<p>意思是 <code>logger.getLogger()</code> 时传入相同的变量,会永远返回同一个对象,比如我在当前进程内的任何地方, 使用 <code>log = logger.getLogger("work")</code> 生成的log对象一直是同一个对象,这就是单例模式,官方推荐传入 <code>__name__</code> 因为他是Python包命名空间中模块的名称。</p>
<p>使用logging来讲单例纯粹是一时间没想到有啥能举例子的, 我们就先假如他不是单例的吧<span class="github-emoji" style="display:inline;vertical-align:middle"><span>😬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h2 id="不写单例的普通类">不写单例的普通类</h2>
<blockquote>
<p>手动写一个单例完全是为了记忆单例模式的使用,只是以 logging 模块举例</p>
</blockquote>
<p>先写一个普通的类, 这个类封装了<code>logging</code>类, 没有考虑单例问题</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log 日志</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 接收参数</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># 日志等级</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s % (levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># 格式化结构</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># 是否输出</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># 保存的文件名</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># 日志文件按时间切分</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># 保留日志文件最大数量</span></span><br><span class="line">        <span class="comment"># 日志级别匹配</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># 输出</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>如果我们同时起多个线程去使用, 可能就会出现意料之外的问题</p>
<h2 id="利用-new-实现单例">利用 <code>__new__</code> 实现单例</h2>
<p>我们知道,python实例化时其实是先走 <code>__new__</code> 再走 <code>__init__</code></p>
<p>我们可以重写 <code>__new__</code> 方法,如果发现已生成对象直接返回该对象</p>
<p>同时为了防止多线程的资源竞争,我们使用线程锁来保证同一时间只有一个线程能访问 <code>__new__</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log 日志</span></span><br><span class="line">    <span class="comment"># 使用线程锁防止同一时间多个线程调用__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 接收参数</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># 日志等级</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># 格式化结构</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># 是否输出</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># 保存的文件名</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># 日志文件按时间切分</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># 保留日志文件最大数量</span></span><br><span class="line">        <span class="comment"># 日志级别匹配</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># 输出</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 实例化时先走这里</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 单例模式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># 检查这个类有没有_instance属性</span></span><br><span class="line">            <span class="keyword">with</span> MyLogger._instance_lock:  <span class="comment"># 获取锁</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># 这里获取到锁, 但是有可能在获取中有另一个线程已经创建了对象, 所以这里再判断一次</span></span><br><span class="line">                    <span class="comment"># 没有实例化过</span></span><br><span class="line">                    MyLogger._instance = <span class="built_in">object</span>.__new__(cls)  <span class="comment"># 调用object的__new__方法, 然后自动调用本类的__init__进行实例化, 将实例化的对象赋值</span></span><br><span class="line">        <span class="keyword">return</span> MyLogger._instance  <span class="comment"># 如果已经有了这个属性直接返回</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>运行测试代码, 发现还是会有问题</p>
<p>调试后发现, 即使代码正确捕捉到了 <code>_instance</code> 已经存在, 将其返回了, 但是因为 <code>_instance</code> 是 <code>__new__</code> 的, 还没有进行 <code>__init__</code> 调用, 所以每次又重新运行 <code>__init__</code> , 因为 <code>__init__</code> 里有给 <code>logging</code> 添加 <code>handler</code> 的操作, 所以随着线程的增多, 每次都会多添加一个 <code>handler</code>, 导致记录一次 <code>logging</code> 记录了多个 <code>handler</code>, 每次记录日志就会重复记录很多次</p>
<h2 id="利用-call-实现">利用<code>__call__</code>实现</h2>
<p>我们将代码改造成</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line">    <span class="comment"># 该类继承元类</span></span><br><span class="line">    _instance_lock = threading.Lock()  <span class="comment"># 线程锁</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">         <span class="comment"># 单例模式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls, <span class="string">"_instance"</span>):  <span class="comment"># 检查这个类有没有_instance属性</span></span><br><span class="line">            <span class="keyword">with</span> cls._instance_lock:  <span class="comment"># 获取锁</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls, <span class="string">"_instance"</span>):  <span class="comment"># 这里获取到锁, 但是有可能在获取中有另一个线程已经创建了对象, 所以这里再判断一次</span></span><br><span class="line">                    <span class="comment"># 没有实例化过</span></span><br><span class="line">                    cls._instance = <span class="built_in">super</span>(SingletonType, cls).__call__(*args, **kwargs)  <span class="comment"># 没有实例化过, 调用type基类的__call__方法, 走正常的流程</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>(<span class="params">metaclass=SingletonType</span>):</span></span><br><span class="line">    <span class="comment"># log 日志</span></span><br><span class="line">    <span class="comment"># 使用线程锁防止同一时间多个线程调用__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 接收参数</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># 日志等级</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># 格式化结构</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># 是否输出</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># 保存的文件名</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># 日志文件按时间切分</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># 保留日志文件最大数量</span></span><br><span class="line">        <span class="comment"># 日志级别匹配</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># 输出</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>在这个代码中, 我们指定了<code>MyLogger</code> 的元类是 <code>SingletonType</code>,  其实在python中实例化对象都是在声明这个类时执行<code>type</code>的<code>__new__</code>和<code>__init__</code>(这里每次声明一个新的类都会走一遍), 然后在创建对象时执行<code>type</code>的<code>__call__</code>, 在<code>__call__</code>中调用自定义类的<code>__new__</code>和<code>__init__</code></p>
<p>我们主要是修改了<code>SingletonType</code> 的<code>__call__</code>, 当实例化时首先判断是否存在了, 不存在再走<code>super</code> 也就是 <code>type</code> 的<code>__call__</code>流程</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98440398">一文搞懂什么是Python的metaclass - 知乎 (zhihu.com)</a></p>
<p>当然对于自定义<code>metaclass</code>, 开发者们有相当一部分是认为其会破坏代码的可读性等, 如果你也这么觉得, 我们可以使用下一个方法</p>
<h2 id="自写初始化方法">自写初始化方法</h2>
<p>我们回看第一种方法, 之所以有问题是每次在<code>__init__</code>时会添加一个<code>handler</code>, 那么我们可以修改逻辑, 让他通过别的方法来添加<code>handler</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> StreamHandler, handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogger</span>:</span></span><br><span class="line">    <span class="comment"># log 日志</span></span><br><span class="line">    <span class="comment"># 使用线程锁防止同一时间多个线程调用__new__</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_instance_init</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 接收参数</span></span><br><span class="line">        self.level = (kwargs[<span class="string">"level"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"level"</span>) <span class="keyword">else</span> <span class="string">"debug"</span>)  <span class="comment"># 日志等级</span></span><br><span class="line">        self.<span class="built_in">format</span> = (kwargs[<span class="string">"format"</span>] <span class="keyword">if</span> kwargs.get(</span><br><span class="line">            <span class="string">"format"</span>) <span class="keyword">else</span> <span class="string">"%(asctime)s %(levelname)-8s[%(filename)s:%(lineno)d(%(funcName)s)] %(message)s"</span>)  <span class="comment"># 格式化结构</span></span><br><span class="line">        self.console = (kwargs[<span class="string">"console"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"console"</span>) <span class="keyword">else</span> <span class="literal">True</span>)  <span class="comment"># 是否输出</span></span><br><span class="line">        self.file = (kwargs[<span class="string">"file"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"file"</span>) <span class="keyword">else</span> <span class="literal">None</span>)  <span class="comment"># 保存的文件名</span></span><br><span class="line">        self.when = (kwargs[<span class="string">"when"</span>] <span class="keyword">if</span> kwargs.get(<span class="string">"when"</span>) <span class="keyword">else</span> <span class="string">"D"</span>)  <span class="comment"># 日志文件按时间切分</span></span><br><span class="line">        self.backCount = (kwargs[<span class="string">"backCount"</span>]</span><br><span class="line">                          <span class="keyword">if</span> kwargs.get(<span class="string">"backCount"</span>) <span class="keyword">else</span> <span class="number">30</span>)  <span class="comment"># 保留日志文件最大数量</span></span><br><span class="line">        <span class="comment"># 日志级别匹配</span></span><br><span class="line">        self.level_relations = {</span><br><span class="line">            <span class="string">"debug"</span>: logging.DEBUG,</span><br><span class="line">            <span class="string">"info"</span>: logging.INFO,</span><br><span class="line">            <span class="string">"warning"</span>: logging.WARNING,</span><br><span class="line">            <span class="string">"error"</span>: logging.ERROR,</span><br><span class="line">            <span class="string">"critical"</span>: logging.CRITICAL</span><br><span class="line">        }</span><br><span class="line">        self.logger = logging.getLogger(__name__)</span><br><span class="line">        self.<span class="built_in">format</span> = logging.Formatter(self.<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.level_relations.get(self.level):</span><br><span class="line">            self.level = <span class="string">"debug"</span></span><br><span class="line">        self.logger.setLevel(self.level_relations[self.level])</span><br><span class="line">        <span class="keyword">if</span> self.console:</span><br><span class="line">            <span class="comment"># 输出</span></span><br><span class="line">            streamHandler = logging.StreamHandler()</span><br><span class="line">            streamHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(streamHandler)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            timeHandler = handlers.TimedRotatingFileHandler(</span><br><span class="line">                filename=self.file,</span><br><span class="line">                when=self.when,</span><br><span class="line">                backupCount=self.backCount,</span><br><span class="line">                encoding=<span class="string">"utf-8"</span></span><br><span class="line">            )</span><br><span class="line">            timeHandler.setFormatter(self.<span class="built_in">format</span>)</span><br><span class="line">            self.logger.addHandler(timeHandler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 实例化时先走这里</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 单例模式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># 检查这个类有没有_instance属性</span></span><br><span class="line">            <span class="keyword">with</span> MyLogger._instance_lock:  <span class="comment"># 获取锁</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(MyLogger, <span class="string">"_instance"</span>):  <span class="comment"># 这里获取到锁, 但是有可能在获取中有另一个线程已经创建了对象, 所以这里再判断一次</span></span><br><span class="line">                    <span class="comment"># 没有实例化过</span></span><br><span class="line">                    MyLogger._instance = <span class="built_in">object</span>.__new__(cls)  <span class="comment"># 调用object的__new__方法, 然后自动调用本类的__init__进行实例化, 将实例化的对象赋值</span></span><br><span class="line">                    MyLogger._instance._instance_init(*args, **kwargs)  <span class="comment"># 只有第一次初始化时才执行handler</span></span><br><span class="line">        <span class="keyword">return</span> MyLogger._instance  <span class="comment"># 如果已经有了这个属性直接返回</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">        l = MyLogger(level=<span class="string">"debug"</span>, file=<span class="string">"test.log"</span>)</span><br><span class="line">        l.logger.warning(<span class="string">"test"</span>)</span><br><span class="line">    ts = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=test)</span><br><span class="line">        t.start()</span><br><span class="line">        ts.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>保证每次只在需要的时候添加<code>handler</code> 即可</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>单例的实现</p><p><a href="https://chnmig.github.io/2021/09/04/realize_single_case/">https://chnmig.github.io/2021/09/04/realize_single_case/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>ChnMig</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-09-04</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-09-04</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/04/leet_code(1-10)/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">LeetCode解题(1-10)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/09/04/rust_programming_language(1)/"><span class="level-item">Rust程序设计语言(1)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://chnmig.github.io/2021/09/04/realize_single_case/';
            this.page.identifier = '2021/09/04/realize_single_case/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'chnmig' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#单例的实现"><span class="level-left"><span class="level-item">1</span><span class="level-item">单例的实现</span></span></a></li><li><a class="level is-mobile" href="#logging本身就是单例的"><span class="level-left"><span class="level-item">2</span><span class="level-item">logging本身就是单例的</span></span></a></li><li><a class="level is-mobile" href="#不写单例的普通类"><span class="level-left"><span class="level-item">3</span><span class="level-item">不写单例的普通类</span></span></a></li><li><a class="level is-mobile" href="#利用-new-实现单例"><span class="level-left"><span class="level-item">4</span><span class="level-item">利用 __new__ 实现单例</span></span></a></li><li><a class="level is-mobile" href="#利用-call-实现"><span class="level-left"><span class="level-item">5</span><span class="level-item">利用__call__实现</span></span></a></li><li><a class="level is-mobile" href="#自写初始化方法"><span class="level-left"><span class="level-item">6</span><span class="level-item">自写初始化方法</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo.gif" alt="ChnMig的个人网站" height="28"></a><p class="is-size-7"><span>&copy; 2021 ChnMig</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ChnMig"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>